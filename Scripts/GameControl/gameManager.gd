extends Node2D
class_name GameManager

enum MapID {
	FOREST,
	TUTORIAL,
	VESTIBULE
}

enum LevelID {
	FOREST_00,
	VESTIBULE_00
}

var level_paths : Dictionary = {
	LevelID.FOREST_00 : 'res://Scene/level_forest_00.tscn',
	LevelID.VESTIBULE_00 : 'res://Scene/level_vestibule_00.tscn'
}

var marker_names : Dictionary = {
	LevelID.FOREST_00 : 'marker_from_forest',
	LevelID.VESTIBULE_00:  'marker_from_vestibule'
}

var camera : Camera = Camera.new()
var player : Player = preload("res://Scene/player.tscn").instantiate()
var roomContainer : RoomContainer = RoomContainer.new()

#Scenes
var debugScene : String = "res://Scene/debugMap.tscn"

# Called when the node enters the scene tree for the first time.
func _ready() -> void:
	windowsConf()

func _process(delta: float) -> void:
	if Input.is_action_just_released("restart"):
		get_tree().quit()
		OS.create_instance(["res://Scene/main.tscn"])

func init(main : Node2D):
	self.camera.setup(player, null)
	camera.limit_left = 0
	camera.limit_top = 0
	main.add_child(camera)
	main.add_child(player)
	roomContainer.load_room(level_paths[LevelID.FOREST_00])
	main.add_child(roomContainer)
	#DisplayServer.window_set_mode(DisplayServer.WINDOW_MODE_FULLSCREEN)
	#DisplayServer.window_set_mode(DisplayServer.WINDOW_MODE_FULLSCREEN)
	DisplayServer.window_set_mode(DisplayServer.WINDOW_MODE_WINDOWED)
	DisplayServer.window_set_flag(DisplayServer.WINDOW_FLAG_BORDERLESS, true)
	DisplayServer.window_set_size(DisplayServer.screen_get_size())
	center_window(DisplayServer.screen_get_size())

func center_window(new_size: Vector2i):
	# define o tamanho da janela
	DisplayServer.window_set_size(new_size)
	# pega o tamanho da tela
	var screen_size = DisplayServer.screen_get_size()
	# calcula posição para centralizar
	var pos = (screen_size - new_size) / 2
	# move a janela
	DisplayServer.window_set_position(pos)

func windowsConf() -> void:
	DisplayServer.window_set_mode(DisplayServer.WINDOW_MODE_WINDOWED)
	DisplayServer.window_set_flag(DisplayServer.WINDOW_FLAG_BORDERLESS, true)
	DisplayServer.window_set_size(DisplayServer.screen_get_size())
	center_window(DisplayServer.screen_get_size())

func start_shake(intensity: float, decay: float = 1.0) -> void:
	camera.start_shake(intensity,decay)

func resetGame():
	get_tree().reload_current_scene()

func change_room(_map_id) -> void:
	roomContainer.call_deferred("change_room", level_paths[_map_id])
